# Rust 闭包和函数指针

## 闭包

- [定义](https://doc.rust-lang.org/book/ch13-01-closures.html)：捕获它们所处环境的``匿名函数``
- ``闭包的环境``：闭包创建时所能访问的外部作用域中的所有变量。闭包可以捕获这些变量并在自身内部使用
- ``捕获``：闭包如何获取和使用其外部作用域中的变量
    - **默认**规则：按需自动选择

        闭包会根据变量的使用方式，自动选择最轻量的捕获方式。比如，如果只读取变量，则默认以不可变借用 ``&T`` 形式捕获；如果需要修改变量，则默认以可变借用 ``&mut T`` 形式捕获。

    - 需要延长变量[生命周期](./rust-lifetime.md)的情况：显式 ``move``

## 函数指针

### 用法

```rust
fn add(a: i32, b: i32) -> i32 {
    a + b
}

fn calculate(a: i32, b: i32, op: fn(i32, i32) -> i32) -> i32 {
    op(a, b)
}

fn main() {
    // 定义函数指针类型
    let operation: fn(i32, i32) -> i32 = add;
    println!("5 + 3 = {}", operation(5, 3));
    // 函数指针作为参数
    println!("5 + 3 = {}", calculate(5, 3, add));
}
```

## 闭包和函数指针的区别

闭包（``Fn``, ``FnMut``, ``FnOnce``）和函数指针（``fn``，与闭包的大写区分）的区别：

- 函数指针是类型，而闭包是 trait
    - 函数指针实现了所有三个闭包的 trait，所以总是可以在调用期望闭包的函数时传递函数指针作为参数
    - 不能直接返回 trait，因此不能直接返回闭包
        - [如何返回一个 trait](#如何返回一个-trait)
    - 函数指针只能指向全局函数（不能指向方法或闭包），不能捕获环境变量

## 补充

### 如何返回一个 trait

在 Rust 中，不能直接返回一个 trait，因为 trait 是抽象概念，**没有固定大小**（``!Sized``）。但可以返回实现了某个 trait 的**类型**。

- 使用 trait 对象 ``dyn Trait``：动态分发机制 [关于动/静态分发](https://zhuanlan.zhihu.com/p/163650432)
    - ``Box<dyn Trait>``
    - ``&dyn Trait``
- 使用 ``impl Trait`` 语法
    - 本质属于静态分发：**编译时**即确定具体调用哪个实现
    - 因此要求：所有返回路径（如 if/else 分支）必须返回同一具体类型（编译时已知）
    - 调用者不知道具体类型，但编译器知道
- 使用 ``enum``：如果可能返回的类型有限
    - 为 ``enum`` 类型实现 trait，返回时返回 ``enum`` 类型
- 使用泛型
    - 静态分发
    - 调用者知道具体类型，编译器也知道
